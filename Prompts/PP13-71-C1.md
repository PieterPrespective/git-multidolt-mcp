- IssueID = PP13-71-C1
- Please read 'Prompts/BasePrompt.md' first for general context
- The PP13-71 integration tests are failing, blocking validation of document-level merge preview conflict detection. These failures indicate that the three-way diff implementation is never being invoked because Dolt's native preview returns table-level summaries.
- For context please read:
	- The PP13-71 assignment in 'Prompts/PP13-71.md' - the foundational design for document-level conflict detection
	- The PP13-71 implementation logged in the chroma design planning database under collection 'PP13-71'
	- The test failure logs in 'Examples/260109_1523/' - detailed output showing the control flow problem
- This assignment specifically focuses on fixing the 2 failing PP13-71 integration tests by ensuring the three-way diff fallback is triggered when Dolt returns table-level summaries:

## **Test Failure Analysis - 2 of 11 Tests Failing**

### **Issue 1: FallbackConflictAnalysis Never Called (Critical)**
**Tests**:
- `PP13_71_PreviewMerge_DocumentLevelConflicts_DetectedCorrectly`
- `PP13_71_PreviewMerge_ContentHashesComputed`

**Problem**: The `FallbackConflictAnalysis` method with three-way diff implementation is never invoked because Dolt's native `DOLT_PREVIEW_MERGE_CONFLICTS_SUMMARY` returns a valid (non-empty) JSON response.

**Evidence from test log**:
```
dbug: Parsing conflict JSON: {"rows": [{"num_data_conflicts":1,"num_schema_conflicts":0,"table":"chroma_sync_state"},{"num_data_conflicts":2,"num_schema_conflicts":0,"table":"documents"}]}

warn: Could not extract collection name from conflict element: {...}
warn: Could not extract document ID from conflict element: {...}
dbug: Conflict conf_8c5cc27f91b9: Modified fields overlap = False
info: Merge analysis complete: 1 conflicts, 1 auto-resolvable
```

**Root Cause**: The control flow in `ConflictAnalyzer.AnalyzeMergeAsync` only calls `FallbackConflictAnalysis` when the Dolt result is empty/null:

```csharp
if (string.IsNullOrWhiteSpace(conflictJson) || conflictJson == "[]")
{
    conflictJson = await FallbackConflictAnalysis(sourceBranch, targetBranch);
}
```

But Dolt returns: `{"rows": [{"num_data_conflicts":2,"table":"documents"}]}` - a **table-level summary**, not document-level conflicts. This is valid JSON, so the fallback is skipped.

### **Issue 2: Wrong Auto-Resolvable Result (Consequence)**
**Test Assertion**: `can_auto_merge` expected `false`, but was `true`

**Cause Chain**:
1. Dolt returns table-level summary (not empty)
2. `FallbackConflictAnalysis` not called → content fields never populated
3. `ParseConflictSummary` creates generic conflict with `BaseContent/OursContent/TheirsContent = null`
4. `CanAutoResolveConflictAsync` falls back to field-level analysis
5. Empty field dictionaries → "Modified fields overlap = False" → auto-resolvable = true

### **Issue 3: Content Hashes Null (Consequence)**
**Test Assertion**: `base_content_hash` expected not null, but was `null`

**Cause**: Same as Issue 2 - the three-way diff code that populates `BaseContentHash`, `OursContentHash`, `TheirsContentHash` is never executed.

## **Assignment Objectives**

### **Primary Goals:**
1. **Fix Fallback Trigger Condition**: Detect when Dolt returns table-level summaries and trigger `FallbackConflictAnalysis`
2. **Ensure Document-Level Conflicts**: Generate individual conflicts per document, not per table
3. **Populate Content Fields**: Ensure `BaseContent/OursContent/TheirsContent` and hashes are filled
4. **Correct Auto-Resolvable Logic**: Return `false` when both branches modified same content differently

### **Success Criteria:**
```
Total tests: 11
     Passed: 11 ✅
     Failed: 0 ✅
```

Expected merge preview result for PP13-71 test scenario:
- `can_auto_merge: false` (both branches modified same documents differently)
- `conflicts.length: 2` (someid1 and someid2)
- Each conflict has `collection: "pp71-collection"` (not "documents")
- Each conflict has `auto_resolvable: false`
- Content fields populated when `detailed_diff: true`

### **Implementation Requirements:**

1. **Modify Fallback Trigger Logic in ConflictAnalyzer**:

   The fallback should be triggered when:
   - Result is empty/null (current behavior)
   - **NEW**: Result is a table-level summary (has `num_data_conflicts` but no `document_id`)

   Suggested approach - detect table-level format:
   ```csharp
   private bool IsDoltTableLevelSummary(string conflictJson)
   {
       // Check if this is Dolt's DOLT_PREVIEW_MERGE_CONFLICTS_SUMMARY format
       // which provides table-level counts, not document-level conflicts
       if (string.IsNullOrWhiteSpace(conflictJson)) return false;

       try
       {
           using var doc = JsonDocument.Parse(conflictJson);
           if (doc.RootElement.TryGetProperty("rows", out var rows))
           {
               foreach (var row in rows.EnumerateArray())
               {
                   // Table-level summaries have "num_data_conflicts" and "table"
                   // but NOT "document_id" or "collection"
                   if (row.TryGetProperty("num_data_conflicts", out _) &&
                       !row.TryGetProperty("document_id", out _))
                   {
                       return true;
                   }
               }
           }
       }
       catch { }
       return false;
   }
   ```

2. **Update AnalyzeMergeAsync Control Flow**:
   ```csharp
   var conflictJson = await _doltCli.PreviewMergeConflictsAsync(sourceBranch, targetBranch);

   // Trigger fallback if empty OR if Dolt returned table-level summary
   if (string.IsNullOrWhiteSpace(conflictJson) ||
       conflictJson == "[]" ||
       IsDoltTableLevelSummary(conflictJson))
   {
       _logger.LogInformation("Using three-way diff for document-level conflict detection");
       conflictJson = await FallbackConflictAnalysis(sourceBranch, targetBranch);
   }
   ```

3. **Validate Three-Way Diff Populates Content**:
   - Verify `DetectDocumentConflictsForTable` creates conflicts with content fields
   - Ensure `ComputeValueHash` is called for hash population
   - Check that collection name comes from Dolt table metadata, not just "documents"

4. **Map Table Names to Collection Names**:
   - The Dolt table "documents" may correspond to collection "pp71-collection"
   - May need to query collections table or use naming conventions to map

### **Technical Constraints:**
- **DO NOT** remove the existing Dolt native preview functionality - it may work for other scenarios
- **MAINTAIN** all passing PP13-71 unit tests (9 tests currently pass)
- **PRESERVE** the three-way diff implementation already written
- **ENSURE** internal table filtering continues to work

### **Validation Process:**
1. Run PP13-71 integration tests to verify fix: `dotnet test --filter "FullyQualifiedName~PP13_71"`
2. Verify log shows "Using three-way diff for document-level conflict detection"
3. Confirm `conflicts.length == 2` with correct document IDs
4. Verify `can_auto_merge == false`
5. Check content fields are populated when `detailed_diff: true`
6. Run full test suite to ensure no regressions

## **Expected Outcome**
All PP13-71 tests pass, validating that:
- Document-level conflicts are detected (not table-level)
- Both documents `someid1` and `someid2` show as individual conflicts
- Conflicts are correctly marked as NOT auto-resolvable
- Content fields (base/ours/theirs) are populated for detailed diff
- Collection name is correctly identified
- Internal tables are excluded from counts

**Priority**: **High** - Merge preview accuracy is critical for user experience.

## **Files Likely to be Modified**
- `multidolt-mcp/Services/ConflictAnalyzer.cs` - Add `IsDoltTableLevelSummary` detection and update control flow
- Potentially `multidolt-mcp/Services/DoltCli.cs` - If table-to-collection mapping is needed

## **Test Files Reference**
- `multidolt-mcp-testing/IntegrationTests/MergePreviewIntegrationTests.cs` - Contains the failing tests
- `Examples/260109_1523/` - Contains detailed test failure logs

Please log all development actions to the 'chroma-feat-design-planning-mcp' database under collection 'PP13-71' following the established pattern.
