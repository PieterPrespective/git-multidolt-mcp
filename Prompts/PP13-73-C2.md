- IssueID = PP13-73-C2
- Please read 'Prompts/BasePrompt.md' first for general context
- The PP13-73-C1 fix for conflict ID consistency is working correctly, but merge execution continues to fail in production. Deep analysis of the issue report in 'Examples/260112_MergeExecutionIssue2/260112_DoltMergeExecutionIssueFindings2.md' reveals two additional critical bugs that were not covered by existing tests.
- For context please read:
	- The PP13-73 parent issue documentation in 'Prompts/PP13-73.md' - original merge execution bug fixes
	- The PP13-73-C1 implementation summary in the 'PP13-73-C1' Chroma collection - conflict ID consistency fix
	- The issue report at 'Examples/260112_MergeExecutionIssue2/260112_DoltMergeExecutionIssueFindings2.md'
	- The execution log at 'Examples/260112_MergeExecutionIssue2/vm-rag.log' (lines 355-530 most relevant)
	- The Dolt database dump at 'Examples/260112_MergeExecutionIssue2/doltdump/' showing incorrect final state
- This assignment focuses on fixing two critical bugs that cause merge conflict resolution to fail silently:

## **Root Cause Analysis - Two Critical Bugs**

### **Bug 1: Dolt Autocommit Mode Blocks SQL-Based Conflict Resolution (Critical)**

**Problem**: The `ResolveDocumentConflictAsync` method in `DoltCli.cs` executes SQL via `dolt sql -q <sql>`, which runs in autocommit mode. Dolt **explicitly rejects** SQL modifications to conflict tables (`dolt_conflicts_*`) when autocommit is enabled during an active merge.

**Error Message from Dolt:**
```
Merge conflict detected, @autocommit transaction rolled back. @autocommit must be
disabled so that merge conflicts can be resolved using the dolt_conflicts and
dolt_schema_conflicts tables before manually committing the transaction.
Alternatively, to commit transactions with merge conflicts, set @@dolt_allow_commit_conflicts = 1
```

**Evidence from Log (vm-rag.log lines 390-395, 419-422):**
```
[11:38:57.304] ERRR: Failed to resolve document conflict for someid1 in documents (collection: main)
DELETE FROM dolt_conflicts_documents WHERE our_doc_id = 'someid1'...
Merge conflict detected, @autocommit transaction rolled back...
```

**Location**: `DoltCli.cs` lines 993 (keep_ours DELETE) and 1018 (keep_theirs UPDATE)

**Note**: The PP13-73-C1 conflict ID fix IS working correctly - IDs match between Preview and Execute:
- Line 382: `PP13-73-C1: GenerateConflictId input='main_someid1_ContentModification' => 'conf_9a2d8f82864c'`
- Line 387: `Applying user resolution for conflict conf_9a2d8f82864c: KeepOurs`

The resolution was correctly matched - the SQL execution failed **afterward** due to autocommit.

### **Bug 2: Second Merge Attempt Reports False Success (Critical)**

**Problem**: After the first merge fails (with autocommit error), the repository remains in "merge in progress" state with unresolved conflicts. When a second `ExecuteDoltMerge` is called:

1. `ProcessMergeAsync` calls `MergeAsync("sourceBranch")`
2. Dolt returns success (merge already in progress, nothing new to merge)
3. `MergeAsync` parses this as `Success=true, HasConflicts=false` (no "CONFLICT" string in output)
4. `ProcessMergeAsync` skips conflict handling entirely and reports success
5. Result: "0 conflicts resolved, 0 documents synced" - false positive

**Evidence from Log (vm-rag.log lines 498-517):**
```
[11:39:35.802] TOOLCALL START : ExecuteDoltMerge - source: mergetestbranch2
[11:39:36.668] Starting merge from mergetestbranch2 to mergetestbranch1
--- NO conflict detection/resolution logs ---
[11:39:39.230] TOOLCALL EXIT : SUCCESS - Merge completed: 0 conflicts resolved, 0 documents synced
```

**Location**:
- `DoltCli.MergeAsync()` line 864: `hasConflicts = result.Output.Contains("CONFLICT")`
- `SyncManagerV2.ProcessMergeAsync()` lines 887-913: Only enters conflict handling if `!mergeResult.Success && mergeResult.HasConflicts`

## **Assignment Objectives**

### **Primary Goals:**
1. **Fix Autocommit Issue**: Implement transaction-based SQL execution for conflict resolution
2. **Fix Merge State Detection**: Detect existing conflicts before starting a new merge
3. **Add Merge Abort on Failure**: Clean up merge state when resolution fails
4. **Add Result Verification**: Verify document content actually changed after resolution

### **Success Criteria:**
```
- Conflict resolution SQL executes successfully (no autocommit errors)
- Failed merges properly clean up merge state (abort)
- Second merge attempt correctly detects existing conflicts
- Document content verification confirms resolutions applied
- All existing PP13-73 tests continue to pass
- New integration tests validate real Dolt SQL execution in merge state
```

## **Proposed Implementation**

### **Fix 1: Transaction-Based Conflict Resolution (DoltCli.cs)**

Modify `ResolveDocumentConflictAsync` to execute SQL within a transaction:

```csharp
// Option A: Disable autocommit for the session
var transactionSql = @"
    SET @@autocommit = 0;
    DELETE FROM dolt_conflicts_documents WHERE our_doc_id = '{docId}' AND our_collection_name = '{collection}';
    COMMIT;
    SET @@autocommit = 1;
";

// Option B: Use dolt_allow_commit_conflicts flag
var allowConflictsSql = @"
    SET @@dolt_allow_commit_conflicts = 1;
    DELETE FROM dolt_conflicts_documents WHERE our_doc_id = '{docId}' AND our_collection_name = '{collection}';
    SET @@dolt_allow_commit_conflicts = 0;
";
```

**Recommended**: Option A (transaction-based) is cleaner and follows Dolt's recommended pattern.

### **Fix 2: Pre-Merge State Validation (ExecuteDoltMergeTool.cs)**

Add check for existing conflicts before starting a new merge:

```csharp
// Before calling ProcessMergeAsync, check for existing merge state
var hasExistingConflicts = await _doltCli.HasConflictsAsync();
if (hasExistingConflicts)
{
    return new {
        success = false,
        error = "MERGE_IN_PROGRESS",
        message = "A merge is already in progress with unresolved conflicts. " +
                  "Resolve existing conflicts or abort the merge before starting a new one."
    };
}
```

### **Fix 3: Merge Abort on Resolution Failure (ExecuteDoltMergeTool.cs)**

Add cleanup when conflict resolution fails:

```csharp
// After conflict resolution attempts, if any failed
if (remainingConflicts)
{
    // Abort the merge to clean up state
    await _doltCli.ExecuteDoltCommandAsync("merge", "--abort");

    return new {
        success = false,
        error = "CONFLICT_RESOLUTION_FAILED",
        message = "Conflict resolution failed. Merge has been aborted.",
        // ... include failure details
    };
}
```

### **Fix 4: Post-Resolution Verification (MergeConflictResolver.cs)**

Add verification that resolution actually changed the document:

```csharp
// After UPDATE for keep_theirs
var verifyResult = await _doltCli.QueryAsync<Dictionary<string, object>>(
    $"SELECT content FROM documents WHERE doc_id = '{docId}' AND collection_name = '{collection}'");

var actualContent = verifyResult.FirstOrDefault()?["content"]?.ToString();
if (actualContent != expectedTheirsContent)
{
    _logger.LogError("Resolution verification failed: content mismatch");
    return false;
}
```

## **Implementation Requirements**

1. **Transaction SQL Execution**:
   - Create new method `ExecuteTransactionAsync(string[] sqlStatements)` in DoltCli
   - Or modify `ExecuteAsync` to support transaction wrapping
   - Ensure proper error handling and rollback on failure

2. **Merge State Management**:
   - Add `IsMergeInProgressAsync()` method to IDoltCli/DoltCli
   - Add `MergeAbortAsync()` method to IDoltCli/DoltCli
   - Update ExecuteDoltMergeTool to use these methods

3. **Result Verification**:
   - Add content verification after keep_theirs resolution
   - Log verification results for debugging
   - Return failure if verification fails

4. **Test Coverage**:
   - Add integration test that executes real conflict resolution SQL
   - Add test for merge-in-progress detection
   - Add test for merge abort on failure
   - Add test for second merge attempt after failed first attempt

## **Technical Constraints**
- **DO NOT** break existing PP13-73 conflict ID consistency
- **MAINTAIN** all PP13-73-C1 test functionality
- **PRESERVE** the auxiliary table auto-resolution logic
- **ENSURE** backward compatibility with existing merge workflows

## **Validation Process**
1. Run existing PP13-73 tests to ensure no regressions
2. Create new test that reproduces the autocommit error scenario
3. Verify transaction-based SQL execution resolves conflicts successfully
4. Test merge-in-progress detection and abort functionality
5. Run full merge test suite to validate end-to-end workflow

## **Expected Outcome**
Merge execution works correctly with:
- Conflict resolution SQL executes within transactions (no autocommit errors)
- Failed merges are properly cleaned up (aborted)
- Second merge attempts correctly detect existing conflict state
- Document content is verified after resolution
- User-specified resolutions are reliably applied

**Priority**: **Critical** - Merge execution is a core feature that is currently broken in production.

## **Files to be Modified**
- `multidolt-mcp/Services/DoltCli.cs` - Transaction-based SQL execution
- `multidolt-mcp/Services/IDoltCli.cs` - New interface methods
- `multidolt-mcp/Tools/ExecuteDoltMergeTool.cs` - Pre-merge validation, abort on failure
- `multidolt-mcp/Services/MergeConflictResolver.cs` - Post-resolution verification
- `multidolt-mcp-testing/IntegrationTests/MergePreviewIntegrationTests.cs` - New tests

Please log all development actions to the 'chroma-feat-design-planning-mcp' database under collection 'PP13-73-C2' following the established pattern.
