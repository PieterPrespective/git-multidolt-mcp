# PP13-72: Fix Merge Execution Issues - Remote Branch Fetch & Conflict Resolution

- IssueID = PP13-72
- Please read 'Prompts/BasePrompt.md' first for general context
- This assignment addresses two critical issues discovered during merge execution testing in the deployed DMMS system
- For context please read:
  - The issue report in 'Examples/260109_MergeExecutionTestIssue.md' - detailed test scenario and failures
  - The PP13-71 implementation which fixed merge preview - prerequisite for merge execution

---

## Executive Summary

Two critical issues were discovered during merge execution testing:

1. **Issue A (Medium)**: Remote branches not visible after `DoltFetch` - users cannot preview/execute merges with remote branches
2. **Issue B (Critical)**: Individual conflict resolutions ignored - `keep_theirs` resolution was not applied, causing data integrity issues

---

## Issue A: Remote Branch Fetch Failure

### Symptoms
- `DoltFetch` reports "Already up to date" but doesn't retrieve remote branch references
- `DoltBranches` only lists local branches, not remote tracking branches
- `PreviewDoltMerge` fails with `SOURCE_BRANCH_NOT_FOUND` for valid remote branches
- Workaround: Direct checkout of remote branch by name

### Root Cause Analysis

**File**: `multidolt-mcp/Tools/DoltFetchTool.cs`

The `DoltFetch` tool has incomplete implementation (lines 96-100):
```csharp
// Get list of updated branches
// TODO: Track which branches were actually updated by the fetch
var branchesUpdated = new List<object>();
var newBranches = new List<string>();
int totalCommitsFetched = 0;
```

The TODOs indicate that:
1. Branch update tracking was never implemented
2. New branch detection was never implemented
3. Commit count calculation was never implemented

**File**: `multidolt-mcp/Services/DoltCli.cs`

The `ListBranchesAsync` method (line 344) uses:
```csharp
var result = await ExecuteDoltCommandAsync("branch", "-v");
```

This command only lists **local branches**. It does not use:
- `-a` flag to list all branches (local + remote)
- `-r` flag to list remote branches only

After fetch, remote branches exist as `remotes/origin/<branch>` but are not enumerated.

### Required Fixes

1. **DoltCli.cs**: Add `ListAllBranchesAsync()` or modify `ListBranchesAsync()` to use `-a` flag
2. **DoltCli.cs**: Add method to parse remote branch references (e.g., `remotes/origin/mergetestbranch2`)
3. **DoltFetchTool.cs**: Implement branch update tracking by comparing branch refs before/after fetch
4. **DoltFetchTool.cs**: Populate `newBranches` list with newly fetched remote branches
5. **PreviewDoltMergeTool.cs**: Consider remote branch references when validating branch existence

---

## Issue B: Merge Conflict Resolution Not Applied

### Symptoms
- User specified mixed resolutions: `conf_9a2d8f82864c: keep_ours`, `conf_e66ed18e46ac: keep_theirs`
- After merge, both documents had `keep_ours` content
- `keep_theirs` resolution for `someid2` was completely ignored

### Root Cause Analysis

**Multiple compounding issues identified:**

#### Problem 1: JSON Input Format Mismatch

**File**: `multidolt-mcp/Tools/ExecuteDoltMergeTool.cs` (lines 120-146)

The tool expects `ConflictResolutionData` structure:
```json
{
  "Resolutions": [
    {"ConflictId": "conf_xxx", "ResolutionType": "KeepOurs"},
    {"ConflictId": "conf_yyy", "ResolutionType": "KeepTheirs"}
  ],
  "DefaultStrategy": "ours"
}
```

But the user provided a simple dictionary:
```json
{
  "conf_9a2d8f82864c": "keep_ours",
  "conf_e66ed18e46ac": "keep_theirs"
}
```

The JSON deserialization silently fails (caught in try-catch), resulting in `resolutions = null`.

#### Problem 2: Table-Level Resolution Overwrites Per-Document Resolutions

**File**: `multidolt-mcp/Services/MergeConflictResolver.cs` (lines 226-240, 245-259)

The `ResolveKeepOurs` and `ResolveKeepTheirs` methods call:
```csharp
var result = await _doltCli.ResolveConflictsAsync(conflict.Collection, ConflictResolution.Ours);
```

**File**: `multidolt-mcp/Services/DoltCli.cs` (lines 676-680)

```csharp
public async Task<DoltCommandResult> ResolveConflictsAsync(string tableName, ConflictResolution resolution)
{
    var strategy = resolution == ConflictResolution.Ours ? "--ours" : "--theirs";
    return await ExecuteDoltCommandAsync("conflicts", "resolve", strategy, tableName);
}
```

**Critical Flaw**: The `dolt conflicts resolve --ours documents` command resolves **ALL conflicts in the entire table** with the same strategy. When processing:
1. First conflict (`someid1`): `keep_ours` → resolves ALL documents conflicts with `--ours`
2. Second conflict (`someid2`): `keep_theirs` → resolves ALL documents conflicts with `--theirs`

But by this point, the first conflict was already resolved! The second call either:
- Does nothing (conflicts already resolved)
- Overwrites the first resolution if done before commit

#### Problem 3: Auto-Resolution Order

**File**: `multidolt-mcp/Tools/ExecuteDoltMergeTool.cs` (lines 200-216)

When `auto_resolve_remaining = true`:
```csharp
if (auto_resolve_remaining)
{
    var unresolvedConflicts = detailedConflicts
        .Where(c => resolutions == null ||
                   !resolutions.Any(r => r.ConflictId == c.ConflictId))
        .ToList();
    // ... auto-resolve with default strategy
}
```

Since `resolutions` is null (due to JSON parsing failure), ALL conflicts are considered "unresolved" and auto-resolved with the default `ours` strategy.

### Required Fixes

1. **ExecuteDoltMergeTool.cs**: Support both JSON formats:
   - Structured `ConflictResolutionData`
   - Simple dictionary `{"conflict_id": "resolution_type"}`

2. **DoltCli.cs**: Add per-document conflict resolution:
   ```csharp
   ResolveDocumentConflictAsync(string tableName, string documentId, ConflictResolution resolution)
   ```
   This should use SQL to resolve individual document conflicts:
   ```sql
   -- For keep_ours: Delete conflict row to accept "our" version
   DELETE FROM dolt_conflicts_documents WHERE our_doc_id = 'someid2';

   -- For keep_theirs: Update our values with their values, then delete conflict
   UPDATE documents SET content = (SELECT their_content FROM dolt_conflicts_documents WHERE our_doc_id = 'someid2')
   WHERE doc_id = 'someid2';
   DELETE FROM dolt_conflicts_documents WHERE our_doc_id = 'someid2';
   ```

3. **MergeConflictResolver.cs**: Update `ResolveKeepOurs` and `ResolveKeepTheirs` to use per-document resolution

4. **ExecuteDoltMergeTool.cs**: Apply manual resolutions BEFORE any auto-resolution occurs

---

## Assignment Objectives

### Primary Goals

1. **Fix Remote Branch Visibility**: Ensure `DoltFetch` properly retrieves and lists all remote branches
2. **Fix Per-Document Conflict Resolution**: Enable mixed resolution strategies for documents in the same table
3. **Fix JSON Input Format**: Support simple dictionary format for conflict resolutions
4. **Fix Resolution Order**: Ensure manual resolutions are never overwritten by auto-resolution

### Success Criteria

```
Test Case 1: Remote Branch Fetch
  Given: A cloned repository with remote branch 'mergetestbranch2'
  When: DoltFetch is called
  Then: DoltBranches should list 'mergetestbranch2' (or 'remotes/origin/mergetestbranch2')
  And: PreviewDoltMerge should accept 'mergetestbranch2' as source

Test Case 2: Mixed Conflict Resolutions
  Given: Two documents (someid1, someid2) with conflicts
  When: ExecuteDoltMerge with {"someid1": "keep_ours", "someid2": "keep_theirs"}
  Then: someid1 has "ours" content
  And: someid2 has "theirs" content

Test Case 3: Resolution Order
  Given: Conflicts with manual resolutions provided
  When: force_merge=true AND auto_resolve_remaining=true
  Then: Manual resolutions are applied first
  And: Auto-resolution only affects conflicts without manual resolution
```

---

## Implementation Requirements

### Phase 1: Remote Branch Visibility (Issue A)

1. **DoltCli.cs**:
   - Add `ListAllBranchesAsync()` using `dolt branch -a -v`
   - Parse remote branch references (`remotes/origin/branchname`)
   - Add helper to check if branch exists locally OR remotely

2. **DoltFetchTool.cs**:
   - Compare branch list before/after fetch
   - Populate `newBranches` with fetched remote branches
   - Calculate actual commits fetched (if possible)

3. **PreviewDoltMergeTool.cs** / **ExecuteDoltMergeTool.cs**:
   - Accept remote branch references in source_branch parameter
   - Validate against all branches (local + remote)

### Phase 2: Per-Document Conflict Resolution (Issue B)

1. **DoltCli.cs**:
   - Add `ResolveDocumentConflictAsync(tableName, documentId, resolution)`
   - Implement using direct SQL operations on conflict tables

2. **MergeConflictResolver.cs**:
   - Update `ResolveKeepOurs` to use per-document resolution
   - Update `ResolveKeepTheirs` to use per-document resolution
   - Ensure resolution targets specific document, not entire table

### Phase 3: Input Format & Resolution Order (Issue B)

1. **ExecuteDoltMergeTool.cs**:
   - Add parsing for simple dictionary format: `{"conflict_id": "strategy"}`
   - Map string strategies to `ResolutionType` enum
   - Apply manual resolutions before checking for auto-resolve

2. **Add Integration Tests**:
   - Test mixed resolutions across multiple documents
   - Test resolution order with force_merge enabled
   - Test remote branch merge scenarios

---

## Technical Constraints

- **DO NOT** change the fundamental merge workflow - fix the implementation details
- **MAINTAIN** backward compatibility with existing `ConflictResolutionData` JSON format
- **PRESERVE** auto-resolution logic for auxiliary tables (chroma_sync_state, etc.)
- **ENSURE** data integrity - resolutions must be atomic per document

---

## Files to Modify

| File | Changes |
|------|---------|
| `multidolt-mcp/Services/DoltCli.cs` | Add `ListAllBranchesAsync`, `ResolveDocumentConflictAsync` |
| `multidolt-mcp/Services/IDoltCli.cs` | Add interface methods |
| `multidolt-mcp/Tools/DoltFetchTool.cs` | Implement branch tracking, populate results |
| `multidolt-mcp/Tools/ExecuteDoltMergeTool.cs` | Support simple JSON format, fix resolution order |
| `multidolt-mcp/Services/MergeConflictResolver.cs` | Use per-document resolution |
| `multidolt-mcp/Tools/PreviewDoltMergeTool.cs` | Validate remote branches |
| `multidolt-mcp-testing/IntegrationTests/` | Add merge execution tests |

---

## Validation Process

1. Run existing merge preview tests (PP13-71) - should still pass
2. Create integration test for remote branch fetch scenario
3. Create integration test for mixed conflict resolutions
4. Test with real repository `pieter-prespective/newDMMSTest`:
   - Clone repository
   - Fetch all branches
   - Verify `mergetestbranch2` is visible
   - Preview merge with both source/target combinations
   - Execute merge with mixed resolutions
   - Verify document contents match expected resolutions

---

## Priority

**Critical** - Data integrity is at risk when conflict resolutions are silently ignored.

---

Please log all development actions to the 'chroma-feat-design-planning-mcp' database under collection 'PP13-72' following the established pattern.
