- IssueID = PP13-72-C2
- Please read 'Prompts/BasePrompt.md' first for general context
- This is a **continuation investigation** of a recurring merge preview issue. PP13-71 implemented document-level conflict detection which reportedly worked, but is now returning zero conflicts.

## Background Context

- **PP13-71**: Implemented three-way diff for document-level merge conflict detection
- **PP13-72**: Fixed remote branch handling and per-document conflict resolution
- **PP13-72-C1**: Fixed test mock infrastructure (IChromaDbService signatures)
- **Issue Reports**:
  - Original: `Examples/260109_MergePreviewIssue.md`
  - Recurrence: `Examples/260110_MergePreviewIssueRecurrence.md`
- **Chroma Logs**: Query collection `PP13-72-C1` for prior analysis

## Problem Statement

The `PreviewDoltMerge` tool returns **zero conflicts** when merging branches that have different content for the same documents. The user confirms PP13-71's implementation **did work previously** for per-document conflict detection.

**Test Scenario** (from `Examples/260110_MergePreviewIssueRecurrence.md`):
- Repository: `pieter-prespective/newDMMSTest` (cloned)
- On `mergetestbranch1`, documents `someid1` and `someid2` have branch-1 specific content
- On `mergetestbranch2`, same documents have branch-2 specific content
- PreviewDoltMerge returns: `has_conflicts: false, total_conflicts: 0, documents_modified: 0`

## Prior Investigation Summary (PP13-72-C1)

### Key Code Flow Identified
1. `PreviewDoltMergeTool.PreviewDoltMerge()` validates branches via `BranchExistsAsync()` (handles remote branches)
2. Calls `_conflictAnalyzer.AnalyzeMergeAsync(sourceBranch, targetBranch, ...)`
3. `AnalyzeMergeAsync` first tries `PreviewMergeConflictsAsync()` (Dolt's `DOLT_PREVIEW_MERGE_CONFLICTS_SUMMARY`)
4. Falls back to `FallbackConflictAnalysis()` if result is empty/null/table-level

### Fallback Trigger Logic (ConflictAnalyzer.cs:145-151)
```csharp
if (string.IsNullOrWhiteSpace(conflictSummaryJson) ||
    conflictSummaryJson == "[]" ||
    IsDoltTableLevelSummary(conflictSummaryJson))
{
    conflictSummaryJson = await FallbackConflictAnalysis(sourceBranch, targetBranch);
}
```

### Critical Finding: `IsDoltTableLevelSummary` May Not Trigger Fallback
If Dolt returns `{"rows": []}` (empty rows array):
- Not null/empty string ✗
- Not literal `"[]"` ✗
- `IsDoltTableLevelSummary` returns FALSE (foreach loop never executes on empty array) ✗
- **Fallback NOT triggered** → ParseConflictSummary returns empty list

### Unverified Hypotheses Requiring Investigation

**Hypothesis A**: `DOLT_PREVIEW_MERGE_CONFLICTS_SUMMARY` returns `{"rows": []}` and fallback isn't triggered
- Need to add logging to capture actual return value

**Hypothesis B**: `FallbackConflictAnalysis` is called but fails silently
- Branch checkout at line 701 doesn't check result - if checkout fails, wrong commits are compared
- `GetMergeBaseAsync` might fail with remote-only branches
- Reflection-based `ExecuteDoltCommandAsync` (line 1599-1625) might fail silently

**Hypothesis C**: Remote branch name resolution issue
- `BranchExistsAsync("mergetestbranch2")` returns true (finds `remotes/origin/mergetestbranch2`)
- But downstream code passes "mergetestbranch2" to Dolt commands that may not resolve it

**Hypothesis D**: The test scenario differs from when PP13-71 worked
- Branch may have been local when it worked, remote-only when it failed
- Repository state or Dolt version differences

## Assignment Objectives

### Primary Goal: Determine Why FallbackConflictAnalysis Is Not Detecting Conflicts

**IMPORTANT**: The user confirms PP13-71 DID work. Do not assume the implementation is fundamentally broken - find what changed or what condition is different.

### Investigation Steps Required

1. **Add Diagnostic Logging** to trace the exact code path:
   - Log the exact return value from `PreviewMergeConflictsAsync`
   - Log whether `IsDoltTableLevelSummary` triggers the fallback
   - Log entry/exit of `FallbackConflictAnalysis`
   - Log result of `GetMergeBaseAsync`
   - Log checkout results and commit hashes obtained

2. **Test with Local Branches**:
   - Reproduce issue with both branches checked out locally first
   - Compare behavior: local-only vs remote-only source branch

3. **Verify FallbackConflictAnalysis Pipeline**:
   - Confirm `GetMergeBaseAsync` returns valid commit hash
   - Confirm `CheckoutAsync` actually switches branches (check result)
   - Confirm `GetHeadCommitHashAsync` returns different commits for different branches
   - Confirm `GetUserAffectedTables` returns the `main` collection table

4. **Check IsDoltTableLevelSummary Logic**:
   - Add logging to see what JSON is being evaluated
   - Fix to return TRUE for empty `{"rows": []}` if that's the issue

### Success Criteria
- Identify the exact point where conflict detection fails
- Implement fix that restores PP13-71 functionality
- Verify with the exact test scenario from `Examples/260110_MergePreviewIssueRecurrence.md`
- All existing tests continue to pass

## Files to Investigate/Modify

| File | Purpose |
|------|---------|
| `multidolt-mcp/Services/ConflictAnalyzer.cs` | Main conflict detection - add logging, potential fixes |
| `multidolt-mcp/Services/DoltCli.cs` | `GetMergeBaseAsync`, `CheckoutAsync` behavior |
| `multidolt-mcp/Tools/PreviewDoltMergeTool.cs` | Entry point, branch validation |
| `multidolt-mcp-testing/IntegrationTests/MergePreviewIntegrationTests.cs` | Existing tests to verify |

## Key Code Locations

| Location | Description |
|----------|-------------|
| `ConflictAnalyzer.cs:59-98` | `IsDoltTableLevelSummary` - empty array handling |
| `ConflictAnalyzer.cs:145-151` | Fallback trigger logic |
| `ConflictAnalyzer.cs:677-751` | `FallbackConflictAnalysis` - three-way diff implementation |
| `ConflictAnalyzer.cs:701-706` | Branch checkouts (results not checked!) |
| `ConflictAnalyzer.cs:756-796` | `GetUserAffectedTables` - table detection |
| `DoltCli.cs:1448-1467` | `GetMergeBaseAsync` implementation |
| `DoltCli.cs:1477-1534` | `GetDocumentChangesBetweenCommitsAsync` implementation |

## Technical Constraints

- **DO NOT** assume the PP13-71 implementation is wrong - it worked before
- **ADD LOGGING FIRST** before making fixes to understand the actual failure
- **PRESERVE** all existing functionality
- **TEST** with the exact scenario from the issue report

## Validation Process

1. Add diagnostic logging to trace code path
2. Run PreviewDoltMerge against `pieter-prespective/newDMMSTest` repository
3. Analyze logs to identify failure point
4. Implement targeted fix
5. Verify fix with issue scenario
6. Run full test suite to ensure no regressions

## Expected Outcome

PreviewDoltMerge correctly detects 2 document-level conflicts for `someid1` and `someid2` when merging `mergetestbranch2` into `mergetestbranch1`.

**Priority**: **High** - Merge preview is a core feature for the MCP tool.

Please log all development actions to the 'chroma-feat-design-planning-mcp' database under collection 'PP13-72-C2' following the established pattern.
