- IssueID = PP13-26
- Please read 'Prompts/BasePrompt.md' first for general context
- Please read the following documents for context:
	- Documentation/tdd/Implementation Overview.md
	- Documentation/tdd/Plan analysis - Dolt and Chroma.md
- Please review the  report on 'PP13-23' in the chroma issue database, this issue is a continuation
- Currently the implementation of the Chroma database functions in the MCP aren't working
	- The implementation in 'ChromaPersistentDbService' seem to be rather arbitrary (and not in line with the actual functioning of chromaDB)
	- Please refactor this service to make use of Python.net and chromadb (the python library)
		- See below for an implementation outline
	- If possible, use this implementation for all ChromaDBService variants - its better to use the proven python library for operations, and marshalling costs should not affect interaction greatly




### **Python.NET (Recommended)**

This is probably your best option. [Python.NET](https://github.com/pythonnet/pythonnet) lets you embed Python and call Python libraries directly from C#.

csharp

```csharp
using Python.Runtime;

public class ChromaDbService : IDisposable
{
    private dynamic _chromadb;
    private dynamic _client;
    private dynamic _collection;

    public ChromaDbService(string persistPath)
    {
        // Initialize Python runtime
        Runtime.PythonDLL = @"C:\Python311\python311.dll"; // Adjust path
        PythonEngine.Initialize();
        
        using (Py.GIL()) // Acquire the Python Global Interpreter Lock
        {
            _chromadb = Py.Import("chromadb");
            
            // Create a persistent client
            _client = _chromadb.PersistentClient(path: persistPath);
        }
    }

    public void GetOrCreateCollection(string name)
    {
        using (Py.GIL())
        {
            _collection = _client.get_or_create_collection(name: name);
        }
    }

    public void AddDocuments(string[] ids, string[] documents, Dictionary<string, object>[] metadatas = null)
    {
        using (Py.GIL())
        {
            _collection.add(
                ids: ids.ToPython(),
                documents: documents.ToPython(),
                metadatas: metadatas?.ToPython()
            );
        }
    }

    public dynamic Query(string[] queryTexts, int nResults = 5)
    {
        using (Py.GIL())
        {
            return _collection.query(
                query_texts: queryTexts.ToPython(),
                n_results: nResults
            );
        }
    }

    public void Dispose()
    {
        PythonEngine.Shutdown();
    }
}
```

**Setup requirements:**

bash

```bash
# Install Python and chromadb
pip install chromadb

# Install Python.NET NuGet package
dotnet add package pythonnet
```

---

## My Recommendation

**Use Python.NET**. Here's a more complete example:

csharp

```csharp
// Program.cs - .NET 6+ / C# 9.0+
using Python.Runtime;

// Set Python DLL path before anything else
Runtime.PythonDLL = @"C:\Python311\python311.dll";
PythonEngine.Initialize();

try
{
    using (Py.GIL())
    {
        dynamic chromadb = Py.Import("chromadb");
        
        // Persistent client - data survives restarts
        dynamic client = chromadb.PersistentClient(path: "./chroma_data");
        
        // Get or create a collection
        dynamic collection = client.get_or_create_collection(name: "my_collection");
        
        // Add documents
        collection.add(
            ids: new[] { "doc1", "doc2", "doc3" }.ToPython(),
            documents: new[] { 
                "This is about machine learning",
                "This discusses natural language processing",
                "This covers computer vision"
            }.ToPython()
        );
        
        // Query
        dynamic results = collection.query(
            query_texts: new[] { "AI and neural networks" }.ToPython(),
            n_results: 2
        );
        
        // Access results
        Console.WriteLine("Query Results:");
        Console.WriteLine(results["documents"]);
        Console.WriteLine(results["distances"]);
    }
}
finally
{
    PythonEngine.Shutdown();
}
```

**Project file (.csproj):**

xml

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net6.0</TargetFramework>
    <LangVersion>9.0</LangVersion>
  </PropertyGroup>
  <ItemGroup>
    <PackageReference Include="pythonnet" Version="3.0.3" />
  </ItemGroup>
</Project>
```

---

## Key Considerations

|Approach|Pros|Cons|
|---|---|---|
|**Python.NET**|Full ChromaDB functionality, no server needed|Requires Python installed, GIL management|
|**HTTP Client**|Clean separation, official API|Requires running Chroma server|
|**Direct DB**|Pure C#|Loses vector search, unstable schema|