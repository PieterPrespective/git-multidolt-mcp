- IssueID = PP13-56
- Please read 'Prompts/BasePrompt.md' first for general context
- **Critical Bug Fix**: The document commit workflow from PP13-51 has a detector instance inconsistency that prevents manually added documents from being staged to Dolt during commit operations. While local change detection correctly identifies documents, a separate detector instance during staging finds zero changes, causing commits to succeed but with no actual document synchronization to Dolt.
- **Investigation Summary**: Analysis of VM-RAG.log and database dumps from Examples/251222/ reveals that `SyncManagerV2.GetLocalChangesAsync()` successfully detects 1 local change, but `ChromaToDoltSyncer.StageLocalChangesAsync()` uses a different detector instance that returns 0 changes to stage. This creates a critical workflow disconnect where documents are detected but never committed to the version control system.
- **Root Cause Analysis**: 
  - Primary Issue: `SyncManagerV2` creates its own `_chromaToDoltDetector` instance while `ChromaToDoltSyncer` creates a separate `_detector` instance, leading to inconsistent state between detection phases
  - Secondary Issue: Duplicate change detection runs with different results - first detection finds changes, second detection (during staging) finds none
  - Evidence: VM-RAG.log shows "found 1 changes" followed by "Staged 0 changes from ChromaDB", and database dumps confirm no documents were actually staged
- **Supporting Evidence**:
  - Execution log: `Examples/251222/vm-rag.log` lines 164-188 vs line 187 showing detection/staging mismatch
  - Database dumps: `Examples/251222/*.csv` showing empty `local_changes.csv` and missing new document in `documents.csv`
  - PP13-51 implementation: `ChromaAddDocumentsTool` correctly sets `is_local_change=true` but staging fails due to detector inconsistency
- **Assignment Scope**:
  1. **Fix detector instance inconsistency** in `SyncManagerV2` and `ChromaToDoltSyncer`:
     - Ensure both `GetLocalChangesAsync` and `StageLocalChangesAsync` use the same detector instance
     - Alternative: Modify `StageLocalChangesAsync` to accept pre-detected changes as parameter to avoid duplicate detection
     - Verify detector initialization and dependency injection consistency
  2. **Optimize workflow efficiency** to eliminate redundant change detection:
     - Implement pattern: Detect once → Stage detected changes → Commit
     - Remove duplicate `DetectLocalChangesAsync` call in staging phase
     - Ensure thread-safety and state consistency between detection phases
  3. **Add comprehensive logging** for debugging and monitoring:
     - Log detector instance identities in both detection and staging phases
     - Track document IDs and metadata flags (`is_local_change`) throughout the workflow
     - Add timing information to identify potential race conditions
     - Log discrepancies between detection phases
  4. **Implement validation layer** for consistency checking:
     - Compare detection results if multiple detections occur
     - Fail fast if detector instances return different results for same collection
     - Add diagnostic information for troubleshooting detector state differences
  5. **Create comprehensive integration tests** for the complete workflow:
     - Test: Manual document addition → Change detection → Staging → Commit → Verification in Dolt
     - Test: Multiple documents added simultaneously
     - Test: Mixed scenarios with new, modified, and deleted documents
     - Validate that detection and staging phases return consistent results
  6. **Ensure no regression** in:
     - Existing sync operations (Dolt→ChromaDB and ChromaDB→Dolt)
     - Document retrieval and querying functionality
     - Collection discovery and management operations
     - Field mapping and metadata handling from PP13-50
- **Implementation Priority**:
  1. **Critical (P0)**: Fix detector instance inconsistency - this is the core blocker
  2. **High (P1)**: Optimize workflow to eliminate duplicate detection
  3. **Medium (P2)**: Add enhanced logging for debugging
  4. **Low (P3)**: Implement validation layer and comprehensive testing
- **Test Data Requirements**: 
  - Use existing test repository: `pieter-prespective/NewTestDatabase` on DoltHub
  - Expected workflow: Clone → Add document via MCP tool → Successfully detect → Stage → Commit → Verify document in Dolt
  - Validation: Document appears in both ChromaDB and Dolt databases after commit, with proper metadata and content hashes
- **Success Criteria**:
  - Manual document addition via `ChromaAddDocumentsTool` results in successful commit to Dolt
  - `GetLocalChangesAsync` and `StageLocalChangesAsync` return consistent detection results
  - Complete workflow succeeds: Add document → Detect change → Stage to Dolt → Commit → Verify in database dumps
  - Enhanced logging shows clear execution path with detector instance consistency
  - No performance regression in sync operations
  - All existing unit and integration tests pass
  - New integration tests validate the complete manual document addition workflow
- **Technical Notes**:
  - Review `SyncManagerV2` constructor (lines 25-42) and `ChromaToDoltSyncer` initialization
  - Examine detector instance creation in both `GetLocalChangesAsync` (SyncManagerV2.cs:116-200) and `StageLocalChangesAsync` (ChromaToDoltSyncer.cs:39-52)
  - Consider dependency injection patterns to ensure singleton detector behavior
  - Validate that detector state is preserved between detection and staging phases