- IssueID = PP13-72-C1
- Please read 'Prompts/BasePrompt.md' first for general context
- The PP13-69 branch switching validation tests are failing after changes introduced in PP13-70, PP13-71, and PP13-72. These tests previously passed after PP13-69 completion. The failures indicate a systemic incompatibility between the updated `ProcessCheckoutAsync` implementation and the existing test infrastructure.
- For context please read:
	- The PP13-69 architecture overview in 'Prompts/pp13-69.md' - the foundational design for SQLite sync state architecture
	- The PP13-69-C1 achievements - successful architectural promise validation tests
	- The PP13-72 parent issue which addressed remote branch fetch and merge conflict resolution
- This assignment specifically focuses on restoring the 12 failing PP13-69 branch switching validation tests through durable, systemic fixes that ensure future compatibility.

## **Test Failure Analysis - 12 Tests Failing**

### **Root Cause: ProcessCheckoutAsync Rewrite Incompatibility**

The `ProcessCheckoutAsync` method in `SyncManagerV2.cs` was completely rewritten between commit `c93ca00` ("Fix: All tests fully functional again") and the current HEAD. This rewrite introduced breaking changes that the existing tests do not accommodate.

#### **Signature Change**
```csharp
// Old (working):
public async Task<SyncResultV2> ProcessCheckoutAsync(
    string targetBranch, bool createNew = false, bool force = false)

// New (current):
public async Task<SyncResultV2> ProcessCheckoutAsync(
    string targetBranch, bool createNew = false, bool preserveLocalChanges = false)
```

#### **Implementation Change**
The old implementation:
1. Called `GetLocalChangesAsync()` with null-safe handling
2. Called `_chromaService.ListCollectionsAsync()` with graceful fallback: `collections.FirstOrDefault() ?? "default"`
3. Called `FullSyncAsync(currentCollection)` for a single collection

The new implementation:
1. Calls `_dolt.CheckoutAsync()` directly
2. Calls `SyncChromaToMatchBranch()` which expects non-null results from `ListCollectionsAsync()`
3. Calls `UpdateLocalSyncState()` which depends on `_syncStateTracker`

### **Core Problem: Mock Setup Incompatibility**

All failing tests use `Mock.Of<IChromaDbService>()` without setting up method expectations:

```csharp
// Current problematic setup:
_chromaService = Mock.Of<IChromaDbService>();
```

The new `SyncChromaToMatchBranch()` method (lines 707-744) calls:
```csharp
var chromaCollections = await _chromaService.ListCollectionsAsync();
_logger.LogInformation("...Found {Count} collections...", chromaCollections.Count, ...);
```

When `ListCollectionsAsync()` returns `null` (Moq default), calling `.Count` throws `NullReferenceException`, caught by the `catch` block in `ProcessCheckoutAsync`, resulting in `Status = SyncStatusV2.Failed`.

## **Failing Tests (12 Total)**

### **Test File 1: PP13_69_BranchSwitchingValidationTests.cs (5 tests)**
| Test Name | Line | Failure Mode |
|-----------|------|--------------|
| `BranchSwitching_CarryModeWithSyncState_PreservesUserDataCorrectly` | ~137 | NullReferenceException in SyncChromaToMatchBranch |
| `BranchSwitching_EdgeCase_EmptyRepository_NoConflicts` | ~165 | NullReferenceException in SyncChromaToMatchBranch |
| `BranchSwitching_RepeatedCheckouts_NoAccumulatedConflicts` | ~195 | NullReferenceException in SyncChromaToMatchBranch |
| `BranchSwitching_WithLocalChanges_CarryMode_NoSyncStateConflicts` | ~225 | NullReferenceException in SyncChromaToMatchBranch |
| `ValidationTest_ExactScenarioFromFailureLogs_ShouldNowSucceed` | ~255 | NullReferenceException in SyncChromaToMatchBranch |

### **Test File 2: PP13_69_C1_ArchitecturalPromiseTests.cs (6 tests)**
| Test Name | Line | Failure Mode |
|-----------|------|--------------|
| `Checkout_AnyBranch_NoSyncStateConflicts` | 122 | NullReferenceException in SyncChromaToMatchBranch |
| `ProcessCheckoutAsync_LineCountValidation_StaysSimple` | 158 | NullReferenceException in SyncChromaToMatchBranch |
| `ProcessCheckoutAsync_Performance_Under2000ms` | 242 | NullReferenceException in SyncChromaToMatchBranch |
| `PP13_69_Promise_CarryModeSeamless` | 275 | NullReferenceException in SyncChromaToMatchBranch |
| `ArchitecturalValidation_CompleteWorkflow_NoRegressions` | 313 | NullReferenceException in SyncChromaToMatchBranch |
| `SyncManager_ProcessCheckout_NoSyncStateConflicts` | ~290 | NullReferenceException in SyncChromaToMatchBranch |

### **Test File 3: PP13_69_Phase4_ValidationTests.cs (1 test)**
| Test Name | Line | Failure Mode |
|-----------|------|--------------|
| `Phase4_EliminationOfCheckoutConflicts_ExactScenarioResolved` | 125 | NullReferenceException in SyncChromaToMatchBranch |

## **Assignment Objectives**

### **Primary Goals:**
1. **Fix Mock Infrastructure**: Update all test files to properly mock `IChromaDbService` methods
2. **Create Reusable Test Helpers**: Establish a pattern for ChromaDB mocking that prevents future regressions
3. **Validate All Tests Pass**: Ensure all 12 tests return to passing state
4. **Document Mock Requirements**: Create clear documentation of mock setup requirements for SyncManagerV2 tests

### **Success Criteria:**
```
PP13-69 Branch Switching Tests:
     Total:  12
     Passed: 12
     Failed:  0
```

## **Implementation Requirements**

### **Phase 1: Create Test Infrastructure Helper**

Create a helper method or base class that provides properly configured mocks:

```csharp
// Recommended approach - create helper method in each test class or a shared base class
private Mock<IChromaDbService> CreateChromaServiceMock()
{
    var mock = new Mock<IChromaDbService>();

    // Essential: ListCollectionsAsync must return a non-null list
    mock.Setup(x => x.ListCollectionsAsync())
        .ReturnsAsync(new List<string>());

    // Optional: Setup for tests that create collections
    mock.Setup(x => x.GetDocumentsAsync(It.IsAny<string>()))
        .ReturnsAsync(new Dictionary<string, object> { ["ids"] = new List<object>() });

    mock.Setup(x => x.DeleteCollectionAsync(It.IsAny<string>()))
        .Returns(Task.CompletedTask);

    return mock;
}
```

### **Phase 2: Update Test Setup Methods**

Update the `[SetUp]` method in each affected test class:

**PP13_69_BranchSwitchingValidationTests.cs:**
```csharp
[SetUp]
public async Task Setup()
{
    // ... existing setup code ...

    // Replace:
    // _chromaService = Mock.Of<IChromaDbService>();

    // With:
    var chromaMock = new Mock<IChromaDbService>();
    chromaMock.Setup(x => x.ListCollectionsAsync())
        .ReturnsAsync(new List<string>());
    chromaMock.Setup(x => x.GetDocumentsAsync(It.IsAny<string>()))
        .ReturnsAsync(new Dictionary<string, object> { ["ids"] = new List<object>() });
    _chromaService = chromaMock.Object;

    // ... rest of setup ...
}
```

**PP13_69_C1_ArchitecturalPromiseTests.cs:**
```csharp
[SetUp]
public async Task Setup()
{
    // ... existing setup code ...

    // Replace:
    // _chromaService = Mock.Of<IChromaDbService>();

    // With properly configured mock (same pattern as above)
}
```

**PP13_69_Phase4_ValidationTests.cs:**
```csharp
[SetUp]
public async Task Setup()
{
    // ... existing setup code ...

    // Replace:
    // var chromaService = Mock.Of<IChromaDbService>();

    // With properly configured mock (same pattern as above)
}
```

### **Phase 3: Handle Collection-Specific Test Scenarios**

Some tests may need collections to actually exist in the mock. Update mock setup dynamically:

```csharp
// For tests that work with specific collections
chromaMock.Setup(x => x.ListCollectionsAsync())
    .ReturnsAsync(new List<string> { collectionName });
```

### **Phase 4: Validate and Run Full Test Suite**

After making changes:
1. Run all 12 failing tests individually to confirm fixes
2. Run the complete PP13-69 test category to ensure no regressions
3. Run the full test suite to ensure no broader impact

## **Technical Constraints**

- **DO NOT** modify `SyncManagerV2.ProcessCheckoutAsync()` - the implementation is correct
- **DO NOT** modify `SyncChromaToMatchBranch()` - it correctly expects non-null responses
- **ONLY** modify test files to properly configure mocks
- **MAINTAIN** backward compatibility with existing test patterns where possible
- **PRESERVE** test isolation - each test should clean up its own state

## **Files to Modify**

| File | Changes Required |
|------|------------------|
| `multidolt-mcp-testing/IntegrationTests/PP13_69_BranchSwitchingValidationTests.cs` | Update `[SetUp]` to use properly configured `IChromaDbService` mock |
| `multidolt-mcp-testing/IntegrationTests/PP13_69_C1_ArchitecturalPromiseTests.cs` | Update `[SetUp]` to use properly configured `IChromaDbService` mock |
| `multidolt-mcp-testing/IntegrationTests/PP13_69_Phase4_ValidationTests.cs` | Update `[SetUp]` to use properly configured `IChromaDbService` mock |

## **Validation Process**

### **Required Validation Test Set**

After implementing fixes, run the following specific test set to validate success:

```bash
# Primary validation - All 12 affected tests must pass
dotnet test multidolt-mcp-testing/DMMSTesting.csproj --filter "FullyQualifiedName~BranchSwitching_CarryModeWithSyncState_PreservesUserDataCorrectly|FullyQualifiedName~BranchSwitching_EdgeCase_EmptyRepository_NoConflicts|FullyQualifiedName~BranchSwitching_RepeatedCheckouts_NoAccumulatedConflicts|FullyQualifiedName~BranchSwitching_WithLocalChanges_CarryMode_NoSyncStateConflicts|FullyQualifiedName~ValidationTest_ExactScenarioFromFailureLogs_ShouldNowSucceed|FullyQualifiedName~ArchitecturalValidation_CompleteWorkflow_NoRegressions|FullyQualifiedName~Checkout_AnyBranch_NoSyncStateConflicts|FullyQualifiedName~PP13_69_Promise_CarryModeSeamless|FullyQualifiedName~ProcessCheckoutAsync_LineCountValidation_StaysSimple|FullyQualifiedName~ProcessCheckoutAsync_Performance_Under2000ms|FullyQualifiedName~SyncManager_ProcessCheckout_NoSyncStateConflicts|FullyQualifiedName~Phase4_EliminationOfCheckoutConflicts_ExactScenarioResolved"
```

**Expected Result:**
```
Passed: 12
Failed: 0
```

### **Step-by-Step Validation**

1. **Individual Test Validation (for debugging):**
   ```bash
   dotnet test --filter "FullyQualifiedName~Checkout_AnyBranch_NoSyncStateConflicts"
   ```

2. **PP13-69 Category Validation (regression check):**
   ```bash
   dotnet test --filter "Category=PP13-69"
   ```

3. **Full Suite Validation (final confirmation):**
   ```bash
   dotnet test
   ```

### **Specific Test Names for Validation**

The following 12 tests MUST pass for this assignment to be considered complete:

| # | Test Name | Test Class |
|---|-----------|------------|
| 1 | `BranchSwitching_CarryModeWithSyncState_PreservesUserDataCorrectly` | PP13_69_BranchSwitchingValidationTests |
| 2 | `BranchSwitching_EdgeCase_EmptyRepository_NoConflicts` | PP13_69_BranchSwitchingValidationTests |
| 3 | `BranchSwitching_RepeatedCheckouts_NoAccumulatedConflicts` | PP13_69_BranchSwitchingValidationTests |
| 4 | `BranchSwitching_WithLocalChanges_CarryMode_NoSyncStateConflicts` | PP13_69_BranchSwitchingValidationTests |
| 5 | `ValidationTest_ExactScenarioFromFailureLogs_ShouldNowSucceed` | PP13_69_BranchSwitchingValidationTests |
| 6 | `ArchitecturalValidation_CompleteWorkflow_NoRegressions` | PP13_69_C1_ArchitecturalPromiseTests |
| 7 | `Checkout_AnyBranch_NoSyncStateConflicts` | PP13_69_C1_ArchitecturalPromiseTests |
| 8 | `PP13_69_Promise_CarryModeSeamless` | PP13_69_C1_ArchitecturalPromiseTests |
| 9 | `ProcessCheckoutAsync_LineCountValidation_StaysSimple` | PP13_69_C1_ArchitecturalPromiseTests |
| 10 | `ProcessCheckoutAsync_Performance_Under2000ms` | PP13_69_C1_ArchitecturalPromiseTests |
| 11 | `SyncManager_ProcessCheckout_NoSyncStateConflicts` | PP13_69_C1_ArchitecturalPromiseTests |
| 12 | `Phase4_EliminationOfCheckoutConflicts_ExactScenarioResolved` | PP13_69_Phase4_ValidationTests |

## **Expected Outcome**

All 12 PP13-69 branch switching validation tests pass, confirming:
- SQLite sync state architecture remains intact
- Branch switching with ChromaDB sync works correctly
- Test infrastructure properly supports the updated `ProcessCheckoutAsync` implementation
- No regression in existing functionality

## **Future Prevention**

To prevent similar issues:
1. Consider creating a `TestMockFactory` class with standard mock configurations
2. Document required mock setups in test class comments
3. Add integration tests that verify mock configurations match production dependencies

**Priority**: **High** - These tests validate critical PP13-69 architectural promises and must pass before any further development.

Please log all development actions to the 'chroma-feat-design-planning-mcp' database under collection 'PP13-72-C1' following the established pattern.
