- IssueID = PP13-73-C1
- Please read 'Prompts/BasePrompt.md' first for general context
- The PP13-73 implementation fixed auxiliary table conflicts and SQL column name issues, but a **critical bug persists**: Conflict IDs generated by PreviewDoltMerge do not match those generated by ExecuteDoltMerge, causing all user-specified conflict resolutions to fail silently.
- For context please read:
	- The PP13-73 assignment in 'Prompts/PP13-73.md' - original issue and implemented fixes
	- The PP13-72-C4 investigation in Chroma collection 'PP13-72-C4' - initial root cause analysis
	- The issue report in 'Examples/260112_DoltMergePersistIssue/260112_DoltMergeExecutionIssueFindings.md' - production failure evidence
	- The execution log in 'Examples/260112_DoltMergePersistIssue/vm-rag.log' - detailed trace showing ID mismatch
	- The post-implementation analysis in Chroma collection 'PP13-73' document 'post-implementation-analysis-001'
- This assignment specifically focuses on fixing the conflict ID mismatch between Preview and Execute tools.

## **Root Cause Analysis**

### **The Bug: Different Collection Values in Conflict ID Hash**

The `GenerateConflictId` function in `ConflictAnalyzer.cs:1366-1376` creates conflict IDs using:
```csharp
var input = $"{conflict.Collection}_{conflict.DocumentId}_{conflict.Type}";
// SHA256 hash produces: conf_XXXXXXXXXXXX
```

**PreviewDoltMergeTool** and **ExecuteDoltMergeTool** populate `conflict.Collection` differently:

| Tool | Code Path | Collection Value | Example ID |
|------|-----------|------------------|------------|
| PreviewDoltMerge | `FallbackConflictAnalysis()` | Actual collection: `"main"` | `conf_9a2d8f82864c` |
| ExecuteDoltMerge | `GetDetailedConflictsAsync("documents")` | Table name: `"documents"` | `conf_cc2c09bc6700` |

### **Evidence from Production Log**

```
[10:06:50.762] Preview JSON: {"collection":"main","document_id":"someid1"...}
[10:06:50.766] Preview generated: conf_9a2d8f82864c (for someid1)

[10:07:51.855] Execute: Getting detailed conflicts for table documents
[10:07:52.069] Execute generated: conf_cc2c09bc6700 (for someid1)

[10:07:52.070] WARN: Conflict ID conf_9a2d8f82864c not found in merge conflicts
```

### **The Specific Bug Location**

`ConflictAnalyzer.cs:1402-1411` - `ConvertToDetailedConflictInfo` method:
```csharp
var conflict = new DetailedConflictInfo
{
    Collection = tableName,  // BUG: Uses parameter "documents" instead of actual collection!
    DocumentId = conflictRow.GetValueOrDefault("our_doc_id")?.ToString() ?? "",
    Type = ConflictType.ContentModification
};
```

The function **ignores** the `our_collection_name` field from the conflict row and uses the table name parameter instead.

## **Assignment Objectives**

### **Primary Goal:**
Fix `ConvertToDetailedConflictInfo` to extract the actual collection name from the conflict row, ensuring consistent conflict IDs between Preview and Execute.

### **Success Criteria:**
1. PreviewDoltMerge and ExecuteDoltMerge generate **identical conflict IDs** for the same conflicts
2. User-specified resolutions from Preview are found and applied in Execute
3. All existing merge tests continue to pass
4. New end-to-end test validates Preview-to-Execute ID consistency

## **Required Fix**

### **Fix 1: Extract Collection Name from Conflict Row (Primary)**

**File**: `multidolt-mcp/Services/ConflictAnalyzer.cs`
**Method**: `ConvertToDetailedConflictInfo` (lines ~1402-1434)

**Current Code:**
```csharp
var conflict = new DetailedConflictInfo
{
    Collection = tableName,
    DocumentId = conflictRow.GetValueOrDefault("our_doc_id")?.ToString() ?? "",
    Type = ConflictType.ContentModification
};
```

**Required Change:**
```csharp
var conflict = new DetailedConflictInfo
{
    // PP13-73-C1: Extract actual collection name from conflict row for consistent ID generation
    Collection = conflictRow.GetValueOrDefault("our_collection_name")?.ToString() ?? tableName,
    DocumentId = conflictRow.GetValueOrDefault("our_doc_id")?.ToString() ?? "",
    Type = ConflictType.ContentModification
};
```

### **Fix 2: Add Defensive Logging**

Add debug logging to track collection value used in ID generation:
```csharp
_logger.LogDebug("PP13-73-C1: ConvertToDetailedConflictInfo using Collection='{Collection}' for doc '{DocId}'",
    conflict.Collection, conflict.DocumentId);
```

## **Required Test Coverage**

### **New Test: End-to-End Preview-Execute ID Consistency**

Create a test in `MergePreviewIntegrationTests.cs` that:

1. **Sets up a real conflict scenario** with two documents modified on both branches
2. **Calls PreviewDoltMerge** and captures the returned conflict IDs
3. **Calls ExecuteDoltMerge** with those exact conflict IDs and resolutions
4. **Verifies:**
   - The conflict IDs are found (no "not found" warnings)
   - Resolutions are applied correctly
   - Document content matches expected resolution outcome

```csharp
[Test]
public async Task PP13_73_C1_ConflictIds_ConsistentBetweenPreviewAndExecute()
{
    // 1. Setup conflict scenario
    // 2. Call PreviewDoltMerge, capture conflict IDs
    // 3. Call ExecuteDoltMerge with those IDs
    // 4. Verify IDs matched and resolutions applied
}
```

## **Validation Process**

1. **Unit Verification**: Confirm `our_collection_name` is present in conflict rows from `dolt_conflicts_documents`
2. **Build**: Ensure project compiles without errors
3. **Run PP13-73 Tests**: Verify existing tests pass
4. **Run New E2E Test**: Validate Preview-Execute ID consistency
5. **Run All Merge Tests**: Ensure no regressions (`dotnet test --filter "FullyQualifiedName~Merge"`)

## **Expected Outcome**

After this fix:
- PreviewDoltMerge returns conflict ID `conf_XXXX` for document `someid1` in collection `main`
- ExecuteDoltMerge generates the **same** ID `conf_XXXX` for the same document
- User resolutions referencing `conf_XXXX` are found and applied correctly
- Merge results reflect the user's chosen resolutions

## **Technical Constraints**

- **DO NOT** change the conflict ID generation algorithm - only fix the input data
- **MAINTAIN** backward compatibility with existing merge workflows
- **PRESERVE** all PP13-73 auxiliary table auto-resolution functionality
- **ENSURE** the fix works for both single-collection and multi-collection scenarios

## **Files to Modify**

| File | Change |
|------|--------|
| `multidolt-mcp/Services/ConflictAnalyzer.cs` | Fix `ConvertToDetailedConflictInfo` to extract `our_collection_name` |
| `multidolt-mcp-testing/IntegrationTests/MergePreviewIntegrationTests.cs` | Add end-to-end ID consistency test |

## **Priority**

**CRITICAL** - This bug causes all user-specified conflict resolutions to fail silently, resulting in incorrect merge outcomes that don't reflect user intent.

## **Logging Requirements**

Please log all development actions to the 'chroma-feat-design-planning-mcp' database under collection 'PP13-73-C1' following the established pattern.
