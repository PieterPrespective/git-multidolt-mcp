- IssueID = PP13-72-C4
- Please read 'Prompts/BasePrompt.md' first for general context
- The PreviewDoltMerge tool fails to detect conflicts when the source branch exists only remotely (not checked out locally). This is a critical issue that can lead to data loss if users execute merges based on false "no conflicts" responses.
- For context please read:
	- The issue report at 'Examples/260110_MergePreviewOnRemoteBranchIssue.md' - detailed reproduction steps and analysis
	- The PP13-72-C1 and PP13-72-C2 analysis in the 'chroma-feat-design-planning-mcp' database collections - prior fix for empty rows fallback
	- Current implementation of ConflictAnalyzer.cs - specifically the FallbackConflictAnalysis method
	- Current implementation of PreviewDoltMergeTool.cs - branch validation logic
- This assignment focuses on implementing automatic remote branch fetching/tracking before merge preview operations to ensure accurate conflict detection regardless of branch locality.

## **Problem Analysis**

### **Root Cause**
The `FallbackConflictAnalysis` method in `ConflictAnalyzer.cs` (lines 716-803) performs branch checkouts to get HEAD commit hashes:

```csharp
// Get source branch HEAD
await _doltCli.CheckoutAsync(sourceBranch);
sourceCommit = await _doltCli.GetHeadCommitHashAsync();

// Get target branch HEAD
await _doltCli.CheckoutAsync(targetBranch);
targetCommit = await _doltCli.GetHeadCommitHashAsync();
```

When a branch exists only as a remote tracking reference (e.g., `remotes/origin/mergetestbranch2`), the `CheckoutAsync("mergetestbranch2")` command fails or returns an incorrect state, causing:
1. `GetHeadCommitHashAsync()` to return wrong/stale commit hashes
2. Three-way diff to compare incorrect commits
3. Zero conflicts detected when conflicts actually exist

### **Reproduction Scenario**
1. Clone repository with multiple branches
2. Checkout only one branch (e.g., `mergetestbranch1`)
3. Run `PreviewDoltMerge(source: "mergetestbranch2", target: "mergetestbranch1")`
4. Result: "0 conflicts" (WRONG - should be 2)
5. Checkout `mergetestbranch2`, then re-run preview
6. Result: "2 conflicts" (CORRECT)

### **Impact**
- **Data Loss**: Users may execute merges believing no conflicts exist
- **Silent Overwrites**: One branch's changes could overwrite another's
- **False Confidence**: "Execute merge - no conflicts detected" message misleads users

---

## **Assignment Objectives**

### **Primary Goals:**
1. **Detect Remote-Only Branches**: Add capability to distinguish local vs remote-only branches
2. **Auto-Track Remote Branches**: Automatically create local tracking branches when needed for merge preview
3. **Eliminate Checkout-Based Commit Resolution**: Use SQL/command-based commit hash retrieval instead of checkouts
4. **Comprehensive Test Coverage**: Add tests for remote branch handling in merge preview

### **Success Criteria:**
- PreviewDoltMerge correctly detects conflicts when source branch is remote-only
- PreviewDoltMerge correctly detects conflicts when target branch is remote-only
- PreviewDoltMerge correctly detects conflicts when both branches are remote-only
- No branch checkouts performed during conflict analysis (eliminates side effects)
- All existing MergePreview tests continue to pass
- New tests validate remote branch scenarios

---

## **Implementation Requirements**

### **Phase 1: Add Branch Locality Detection to IDoltCli**

Add new methods to `IDoltCli.cs`:

```csharp
/// <summary>
/// Check if a branch exists locally (not just as a remote tracking branch)
/// </summary>
/// <param name="branchName">Name of the branch to check</param>
/// <returns>True if branch exists as a local branch</returns>
Task<bool> IsLocalBranchAsync(string branchName);

/// <summary>
/// Get the commit hash for a branch without checking it out
/// Uses HASHOF() SQL function or merge-base command
/// </summary>
/// <param name="branchName">Name of the branch (local or remote)</param>
/// <returns>Commit hash, or null if branch not found</returns>
Task<string?> GetBranchCommitHashAsync(string branchName);

/// <summary>
/// Create a local tracking branch from a remote branch
/// Equivalent to: dolt checkout -b branchName remotes/origin/branchName
/// </summary>
/// <param name="branchName">Name of the branch to track</param>
/// <param name="remote">Remote name (default: "origin")</param>
/// <returns>Command result with success/failure status</returns>
Task<DoltCommandResult> TrackRemoteBranchAsync(string branchName, string remote = "origin");
```

### **Phase 2: Implement Branch Helper Methods in DoltCli.cs**

```csharp
public async Task<bool> IsLocalBranchAsync(string branchName)
{
    var allBranches = await ListAllBranchesAsync();
    return allBranches.Any(b => b.Name == branchName && !b.IsRemote);
}

public async Task<string?> GetBranchCommitHashAsync(string branchName)
{
    // Try SQL approach first (works for both local and remote refs)
    try
    {
        var sql = $"SELECT HASHOF('{branchName}') as hash";
        var json = await QueryJsonAsync(sql);
        // Parse and return hash...
    }
    catch
    {
        // Fallback: check if it's a remote branch reference
        var allBranches = await ListAllBranchesAsync();
        var remoteName = $"remotes/origin/{branchName}";
        var branch = allBranches.FirstOrDefault(b => b.Name == branchName || b.Name == remoteName);
        return branch?.LastCommitHash;
    }
}

public async Task<DoltCommandResult> TrackRemoteBranchAsync(string branchName, string remote = "origin")
{
    // Create local branch tracking the remote
    var remoteBranch = $"remotes/{remote}/{branchName}";
    return await ExecuteDoltCommandAsync("checkout", "-b", branchName, remoteBranch);
}
```

### **Phase 3: Update PreviewDoltMergeTool.cs**

Add automatic remote branch tracking before conflict analysis:

```csharp
// After branch existence validation (around line 133):

// PP13-72-C4: Ensure branches are locally available for accurate conflict detection
var sourceBranchLocal = await _doltCli.IsLocalBranchAsync(source_branch);
var targetBranchLocal = await _doltCli.IsLocalBranchAsync(target_branch);

if (!sourceBranchLocal)
{
    _logger.LogInformation("Source branch '{Branch}' is remote-only, creating local tracking branch", source_branch);
    var trackResult = await _doltCli.TrackRemoteBranchAsync(source_branch);
    if (!trackResult.Success)
    {
        return new
        {
            success = false,
            error = "BRANCH_TRACK_FAILED",
            message = $"Failed to create local tracking branch for '{source_branch}': {trackResult.Error}"
        };
    }
}

if (!targetBranchLocal)
{
    _logger.LogInformation("Target branch '{Branch}' is remote-only, creating local tracking branch", target_branch);
    var trackResult = await _doltCli.TrackRemoteBranchAsync(target_branch);
    if (!trackResult.Success)
    {
        return new
        {
            success = false,
            error = "BRANCH_TRACK_FAILED",
            message = $"Failed to create local tracking branch for '{target_branch}': {trackResult.Error}"
        };
    }
}
```

### **Phase 4: Update FallbackConflictAnalysis in ConflictAnalyzer.cs**

Replace checkout-based commit resolution with direct hash retrieval:

```csharp
// BEFORE (problematic - requires checkouts):
await _doltCli.CheckoutAsync(sourceBranch);
sourceCommit = await _doltCli.GetHeadCommitHashAsync();

await _doltCli.CheckoutAsync(targetBranch);
targetCommit = await _doltCli.GetHeadCommitHashAsync();

// AFTER (no checkouts needed):
sourceCommit = await _doltCli.GetBranchCommitHashAsync(sourceBranch);
if (string.IsNullOrEmpty(sourceCommit))
{
    _logger.LogWarning("Could not get commit hash for source branch {Branch}", sourceBranch);
    return "[]";
}

targetCommit = await _doltCli.GetBranchCommitHashAsync(targetBranch);
if (string.IsNullOrEmpty(targetCommit))
{
    _logger.LogWarning("Could not get commit hash for target branch {Branch}", targetBranch);
    return "[]";
}
```

This eliminates:
- Side effects from branch checkouts during analysis
- ChromaDB state corruption from unexpected branch switches
- Race conditions in multi-threaded scenarios

### **Phase 5: Add Comprehensive Test Coverage**

Create new test file or add to existing `MergePreviewIntegrationTests.cs`:

```csharp
[Test]
public async Task PreviewMerge_RemoteOnlySourceBranch_DetectsConflicts()
{
    // Setup: Create repo with conflicting branches
    // Only checkout target branch locally
    // Source branch remains remote-only
    // Assert: Conflicts are correctly detected
}

[Test]
public async Task PreviewMerge_RemoteOnlyTargetBranch_DetectsConflicts()
{
    // Setup: Create repo with conflicting branches
    // Only checkout source branch locally
    // Target branch remains remote-only
    // Assert: Conflicts are correctly detected
}

[Test]
public async Task PreviewMerge_BothBranchesRemoteOnly_DetectsConflicts()
{
    // Setup: Clone repo, stay on main
    // Both merge branches are remote-only
    // Assert: Conflicts are correctly detected
}

[Test]
public async Task PreviewMerge_AutoTracksRemoteBranch_Success()
{
    // Setup: Remote-only source branch
    // Act: Call PreviewDoltMerge
    // Assert: Local tracking branch was created
    // Assert: Conflicts detected correctly
}

[Test]
public async Task GetBranchCommitHashAsync_RemoteBranch_ReturnsCorrectHash()
{
    // Verify SQL-based commit hash retrieval works for remote branches
}

[Test]
public async Task IsLocalBranchAsync_RemoteOnly_ReturnsFalse()
{
    // Verify locality detection works correctly
}
```

---

## **Technical Constraints**

- **DO NOT** modify core branch management behavior beyond adding new helper methods
- **MAINTAIN** backwards compatibility with existing merge operations
- **PRESERVE** all existing test functionality - no regressions allowed
- **ENSURE** checkout elimination in FallbackConflictAnalysis doesn't break other code paths
- **VERIFY** SQL HASHOF() function works with remote branch references in Dolt

---

## **Validation Process**

1. Run existing MergePreview integration tests - all must pass
2. Run existing ConflictAnalyzer unit tests - all must pass
3. Manually test with `pieter-prespective/newDMMSTest` repository:
   - Clone fresh
   - Run `PreviewDoltMerge(source: "mergetestbranch2", target: "mergetestbranch1")` WITHOUT prior checkout
   - Verify 2 conflicts detected
4. Run new remote branch tests
5. Verify no branch checkouts occur during conflict analysis (check logs)

---

## **Files to be Modified**

| File | Changes |
|------|---------|
| `multidolt-mcp/Services/IDoltCli.cs` | Add `IsLocalBranchAsync`, `GetBranchCommitHashAsync`, `TrackRemoteBranchAsync` |
| `multidolt-mcp/Services/DoltCli.cs` | Implement new methods |
| `multidolt-mcp/Tools/PreviewDoltMergeTool.cs` | Add auto-tracking of remote branches before analysis |
| `multidolt-mcp/Services/ConflictAnalyzer.cs` | Replace checkout-based commit resolution in FallbackConflictAnalysis |
| `multidolt-mcp-testing/IntegrationTests/MergePreviewIntegrationTests.cs` | Add remote branch test cases |

---

## **Expected Outcome**

After implementation:
1. `PreviewDoltMerge` correctly detects conflicts regardless of branch locality
2. No side effects (branch checkouts) during merge preview analysis
3. Remote branches are automatically tracked when needed
4. Comprehensive test coverage prevents future regressions
5. Users can trust merge preview results for any branch combination

---

## **Priority**

**CRITICAL** - This bug can lead to data loss. Users relying on merge preview to make merge decisions will receive incorrect information, potentially causing destructive merges.

---

Please log all development actions to the 'chroma-feat-design-planning-mcp' database under collection 'PP13-72-C4' following the established pattern.
